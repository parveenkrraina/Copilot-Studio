# Lab 04.2 — Conversation Nodes and Branching

## Overview

In this lab, you'll learn how to build more interactive conversations by combining different types of nodes and adding decision-making logic to your topic.

**Prerequisites:**
- Complete Lab 04.1 (Order Lookup topic that asks for an Order ID and fetches details)

**What you'll learn:**
- Work with different conversation node types
- Create conditional branches based on data
- Build nested branches for complex scenarios
- Implement safe loops that don't get stuck

**Time required:** 30-45 minutes

---

## Understanding Conversation Nodes

Before we start, let's understand the building blocks:

### Node Types

1. **Message Node**
    - Displays text or information to the user
    - Does not wait for user input
    - Use for: greetings, confirmations, status updates

2. **Input Node**
    - Asks the user a question
    - Waits for and captures the user's response
    - Stores the response in a variable
    - Use for: collecting order IDs, names, choices

3. **Action Node**
    - Calls an external service (Power Automate flow, API)
    - Passes data to the service and receives results back
    - Stores results in variables
    - Use for: fetching order details, creating records, sending emails

4. **Branching Node**
    - Creates different conversation paths based on conditions
    - Evaluates variables and directs the flow accordingly
    - Use for: handling different order statuses, yes/no decisions

### Managing Node Sequences

- Nodes execute from top to bottom by default
- You can redirect flow using "Go to node" to create loops
- Keep your node sequences logical and easy to follow
- Name each node clearly (e.g., "Input: Order ID", "Branch: Check Status")

---

## Variables for This Lab

We'll use these variables throughout the exercise:

| Variable | Type | Description |
|----------|------|-------------|
| `user.orderId` | Text | The order ID entered by the user |
| `order.found` | Boolean | Whether the order was found (true/false) |
| `order.status` | Text | Current status: "shipped", "delayed", "processing" |
| `order.eta` | Text | Estimated time of arrival |
| `order.trackingUrl` | Text | Tracking link (optional) |
| `user.notifyChoice` | Text | User's notification preference: "yes" or "no" |

---

## Step-by-Step Instructions

### Step 1: Prepare Your Topic

1. Open your Copilot in Copilot Studio
2. Go to the **Topics** tab
3. Find your "Order Lookup" topic from Lab 04.1
4. Click the **⋯** (three dots) menu and select **Make a copy**
5. Rename the copy to **"Order Lookup (04.2)"**
6. Open the new topic for editing

**Why?** We're creating a copy so you can keep your original Lab 04.1 work intact.

---

### Step 2: Add a Welcome Message Node

Let's start by greeting the user and explaining what this topic does.

1. At the top of your topic (after the trigger phrases), click **+ Add node**
2. Select **Send a message**
3. In the message box, enter:
    ```
    I can help check your order status. Let me look that up for you.
    ```
4. Click outside the node to save

**What you learned:** Message nodes display information without waiting for input.

---

### Step 3: Add an Input Node for Order ID

Now let's ask the user for their order ID with proper validation.

1. Below your message node, click **+ Add node**
2. Select **Ask a question**
3. Configure the question:
    - **Enter a message:** `What is your Order ID? (Example: ABC-12345)`
    - Click **Identify** → Select **User's entire response**
    - **Save response as:** Create a new variable called `user.orderId`

4. Add validation (click on the variable name to expand options):
    - Under **Question behavior**, enable **Reprompt**
    - Set **Max retries:** `2`
    - **Retry prompt:** `I didn't catch that. Please enter your Order ID (6-20 characters, letters, numbers, and dashes only).`

5. Scroll down and enable **Validation**
    - **Pattern matching:** Enter `^[A-Z0-9-]{6,20}$` (this regex ensures 6-20 characters)

**What you learned:** Input nodes capture user responses and can validate them before proceeding.

---

### Step 4: Handle Validation Failures

When validation fails after all retries, we need to handle it gracefully.

1. Look for the **Condition** node that was automatically created below your input
2. Find the **On failure** branch (this triggers after 2 failed attempts)
3. In the **On failure** branch, click **+ Add node**
4. Select **Send a message**
5. Enter:
    ```
    I'm having trouble understanding the Order ID format. Please contact our support team at support@example.com for assistance.
    ```
6. Below that message, click **+ Add node**
7. Select **End conversation** → **End with survey** (or **Transfer to agent** if available)

**What you learned:** Always provide a way out when validation fails—never trap the user in a loop.

---

### Step 5: Add an Action Node to Fetch Order Details

Now we'll call your Power Automate flow (or API) to get order information.

1. Below your input node (on the **Success** path), click **+ Add node**
2. Select **Call an action** → Choose your flow from Lab 04.1
3. **Configure inputs:**
    - Map `user.orderId` to your flow's input parameter
4. **Configure outputs** (map these from your flow's return values):
    - `order.found` (Boolean)
    - `order.status` (Text)
    - `order.eta` (Text)
    - `order.trackingUrl` (Text, optional)

5. Rename this node to **"Action: Get Order Details"** by clicking the node title

**What you learned:** Action nodes connect your copilot to external systems and bring data back into variables.

---

### Step 6: Add Branching Based on Order Status

Now let's create different conversation paths based on what the action returns.

#### Create the main branch

1. Below your action node, click **+ Add node**
2. Select **Add a condition** → **Branch based on a condition**
3. Rename this node to **"Branch: Check Order Found"**

#### Configure Condition 1: Order Not Found

1. In the first condition, click **Select a variable**
2. Choose `order.found`
3. Set the operator to **is equal to** `false`
4. In this branch, click **+ Add node** → **Send a message**
5. Enter:
    ```
    I couldn't find an order with that ID. Let's try again.
    ```
6. Below the message, click **+ Add node** → **Go to another node**
7. Select the **Input: Order ID** node you created in Step 3

**What you learned:** This creates a loop that lets users re-enter their order ID if it's not found.

#### Configure Condition 2: Order Shipped

1. Click **+ New condition**
2. Set up the condition:
    - Variable: `order.status`
    - Operator: **is equal to**
    - Value: `shipped` (type this in)
3. In this branch, click **+ Add node** → **Send a message**
4. Enter (use the {x} icon to insert variables):
    ```
    Great news! Your order has been shipped. 
    
    Estimated arrival: {order.eta}
    ```
5. Add another message node below:
    ```
    Track your order here: {order.trackingUrl}
    ```
6. Below that, click **+ Add node** → **End conversation** → **End with survey**

**What you learned:** Branching lets you show different messages based on data values.

#### Configure Condition 3: Order Delayed

1. Click **+ New condition**
2. Set up the condition:
    - Variable: `order.status`
    - Operator: **is equal to**
    - Value: `delayed`
3. In this branch, click **+ Add node** → **Send a message**
4. Enter:
    ```
    Your order has been delayed. We apologize for the inconvenience.
    
    Current estimated arrival: {order.eta}
    ```
5. **Don't end the conversation yet**—we'll add a nested branch in the next step

#### Configure All Other Conditions (Default)

1. In the **All Other Conditions** branch, click **+ Add node** → **Send a message**
2. Enter:
    ```
    Your order is currently being processed.
    
    Estimated arrival: {order.eta}
    ```
3. Below that, click **+ Add node** → **End conversation** → **End with survey**

**What you learned:** The "All Other Conditions" branch handles any status that doesn't match your specific conditions (like "processing" or "unknown").

---

### Step 7: Add a Nested Branch for Delayed Orders

For delayed orders, let's ask if the user wants notifications.

1. Go back to the **Condition 3: Order Delayed** branch
2. Below your "delayed" message, click **+ Add node** → **Ask a question**
3. Configure the question:
    - **Message:** `Would you like to receive updates when the status changes?`
    - Click **Identify** → Select **Multiple choice options**
    - **Options for user:**
      - Option 1: `Yes, notify me`
      - Option 2: `No, thanks`
    - **Save response as:** Create new variable `user.notifyChoice`

4. Set validation:
    - **Max retries:** `2`
    - **Retry prompt:** `Please choose Yes or No.`

#### Handle "Yes" Response

1. Below your question, a **Condition** node was created automatically
2. In the **Yes, notify me** condition branch:
    - Click **+ Add node** → **Call an action**
    - Select your "Create Notification Subscription" flow (or create a placeholder)
    - Pass `user.orderId` as input
3. Below the action, add a **Send a message** node:
    ```
    Perfect! You'll receive email updates when your order status changes.
    ```
4. Add **End conversation** → **End with survey**

#### Handle "No" Response

1. In the **No, thanks** condition branch:
    - Add a **Send a message** node:
    ```
    No problem. You can always check your order status anytime by saying "check my order".
    ```
2. Add **End conversation** → **End with survey**

#### Handle Invalid Responses

1. In the **On failure** branch (after retries):
    - Add a **Send a message** node:
    ```
    I didn't understand that response. Let me ask again.
    ```
2. Add **Go to another node** → Select the notification question node

**What you learned:** Nested branches let you add follow-up questions and decisions within a specific path. This creates more natural, context-aware conversations.

---

### Step 8: Test Your Topic

Now let's test all the different paths:

#### Test 1: Order Not Found → Retry → Success
1. Click **Test your copilot** (top right)
2. Trigger your topic
3. Enter an invalid order ID (e.g., `INVALID123`)
4. **Expected:** "I couldn't find an order…" → loops back to ask again
5. Enter a valid order ID
6. **Expected:** Appropriate status message

#### Test 2: Shipped Order
1. Start fresh (click **Start over**)
2. Enter an order ID that your flow returns as "shipped"
3. **Expected:** Confirmation with ETA and tracking link

#### Test 3: Delayed Order → Yes to Notifications
1. Start fresh
2. Enter an order ID with status "delayed"
3. **Expected:** Delay message
4. Choose "Yes, notify me"
5. **Expected:** Confirmation of subscription

#### Test 4: Delayed Order → Invalid Input → Retry
1. Start fresh
2. Enter delayed order ID
3. Type random text instead of yes/no
4. **Expected:** Retry prompt
5. Type "No, thanks"
6. **Expected:** Confirmation message

#### Test 5: Order ID Validation Failure
1. Start fresh
2. Enter invalid format three times (e.g., "12", "AB")
3. **Expected:** After 2 retries, see support message and conversation ends

**What you learned:** Testing every path ensures your logic works correctly and users never get stuck.

---

## Understanding Loops and Their Risks

### Safe Loop Pattern (Used in Step 6)
```
Order Not Found → Message → Go to Input Node → Try Again
```
**Safe because:** The Input node has retry limits and a failure path.

### Unsafe Loop (Don't Do This)
```
Order Not Found → Go to Input Node → Order Not Found → Go to Input Node → (infinite)
```
**Dangerous because:** No validation limits or exit path.

### Best Practices for Loops
- ✅ Always use Input node validation with max retries
- ✅ Provide an "On failure" path that ends or transfers
- ✅ Explain to the user why you're looping back
- ✅ Limit loops to 2-3 attempts maximum
- ❌ Never create a loop without an exit condition
- ❌ Don't loop more than 2 levels deep

---

## Tips for Managing Complex Topics

### Keep Branches Shallow
- Maximum 3 levels of nesting
- If you need more, split into separate topics

### Normalize Data Before Branching
Use Power Fx to make comparisons easier:
```
Lower(order.status) = "shipped"
```
This works even if the API returns "Shipped", "SHIPPED", or "shipped"

### Name Your Nodes Clearly
Good names:
- "Input: Order ID"
- "Action: Get Order Details"  
- "Branch: Check Order Found"
- "Branch: Notification Preference"

Bad names:
- "Question"
- "Condition"
- "Condition 2"

### Use Comments
Add notes in complex branches:
1. Right-click a node → **Add a note**
2. Explain why this branch exists

---

## What You Accomplished

✅ Added all four node types (Message, Input, Action, Branching)  
✅ Created conditional logic based on order status  
✅ Built a nested branch for delayed orders  
✅ Implemented safe loops with validation and retries  
✅ Handled edge cases (not found, invalid input)  
✅ Provided clear exit paths for users  

---

## Next Steps

Now that you understand conversation nodes and branching, you can:
- Add more complex conditions using Power Fx expressions
- Create multi-turn conversations with memory
- Chain multiple topics together
- Build adaptive cards for richer responses

**Continue to Lab 04.3** to learn about variables and context management.

